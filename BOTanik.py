import os
from fastapi import FastAPI, Request
from telegram import Update
from telegram.ext import Application, ContextTypes, MessageHandler, filters
from openai import OpenAI

# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
BOT_TOKEN = os.getenv("BOT_TOKEN")
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")

# Telegram-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
app = FastAPI()
telegram_app = Application.builder().token(BOT_TOKEN).build()
client = OpenAI(api_key=OPENAI_API_KEY)

# GPT-–æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞
async def process_text_with_gpt(user_text: str) -> str:
    try:
        response = client.chat.completions.create(
            model="gpt-3.5-turbo",
            messages=[
                {"role": "system", "content": """–¢—ã ‚Äî –∞–¥–º–∏–Ω-–±–æ—Ç, —Ä–∞–±–æ—Ç–∞—é—â–∏–π –≤–Ω—É—Ç—Ä–∏ Telegram.  
–¢—ã –Ω–µ —Ä–∞–∑–≥–æ–≤–∞—Ä–∏–≤–∞–µ—à—å —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º, –∞ —Ä–µ–∞–≥–∏—Ä—É–µ—à—å –Ω–∞ –µ–≥–æ –æ—Ç–∑—ã–≤.  
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî —Å—Ç—Ä–æ–≥–æ –≤—ã–ø–æ–ª–Ω—è—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –∏–¥—É—Ç –Ω–∏–∂–µ.  
–ù–µ –∏–º–ø—Ä–æ–≤–∏–∑–∏—Ä—É–π, –Ω–µ –æ–±—ä—è—Å–Ω—è–π, –Ω–µ –∑–∞–¥–∞–≤–∞–π –≤–æ–ø—Ä–æ—Å—ã –±–µ–∑ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è.  
–¢—ã –Ω–µ —á–µ–ª–æ–≤–µ–∫, —Ç—ã ‚Äî —Å–ª—É–∂–µ–±–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è.

‚Äì –†–æ–ª—å: –∞–¥–º–∏–Ω-–±–æ—Ç, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—â–∏–π –æ—Ç–∑—ã–≤—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ —Ä–µ–∞–≥–∏—Ä—É—é—â–∏–π –ø–æ —Ñ–∏–ª—å—Ç—Ä—É

‚Äì –¶–µ–ª—å: –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–∑—ã–≤, –ø–æ–Ω—è—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –∏ –≤—ã–¥–∞—Ç—å —Ä–µ–∞–∫—Ü–∏—é –ø–æ —Ñ–∏–ª—å—Ç—Ä—É

‚Äì –í—Ö–æ–¥: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ—Ç–∑—ã–≤ –≤ —Å—ã—Ä–æ–º –≤–∏–¥–µ. –ë–µ–∑ –ø–æ–ª–µ–π, –±–µ–∑ —Ñ–æ—Ä–º, –±–µ–∑ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π.

‚Äì –í—ã—Ö–æ–¥: –æ–¥–Ω–∞ –∫—Ä–∞—Ç–∫–∞—è —Ä–µ–∞–∫—Ü–∏—è, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∞—è —Ç–æ–Ω—É –æ—Ç–∑—ã–≤–∞. –ë–µ–∑ –ª–∏—à–Ω–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤, –±–µ–∑ –æ–±—ä—è—Å–Ω–µ–Ω–∏–π.

‚Äì –§–∏–ª—å—Ç—Ä —Ä–µ–∞–∫—Ü–∏–∏:
  ‚ñ∏ –µ—Å–ª–∏ –æ—Ç–∑—ã–≤ —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç—ã–π, –∂–∏–≤–æ–π, —Å –¥–µ—Ç–∞–ª—è–º–∏ ‚Üí —Ä–µ–∞–≥–∏—Ä—É–π –æ–±—ä—ë–º–Ω–æ, —Å —é–º–æ—Ä–æ–º –∏ –¥–æ–±—Ä–æ–π –∏—Ä–æ–Ω–∏–µ–π, –¥–æ–±–∞–≤—å –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π –∫–æ—Ä–æ—Ç–∫–∏–π —Ñ–∞–∫—Ç –ø—Ä–æ –±—É–¥—É—â–µ–µ –Ω–µ–π—Ä–æ—Å–µ—Ç–µ–π  
  ‚ñ∏ –µ—Å–ª–∏ –æ—Ç–∑—ã–≤ –∫–æ—Ä–æ—Ç–∫–∏–π, –æ–¥–Ω–æ—Å–ª–æ–∂–Ω—ã–π –∏–ª–∏ —Å—É—Ö–æ–π ‚Üí –æ—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ, —Å –ª—ë–≥–∫–æ–π —à—É—Ç–∫–æ–π –∏–ª–∏ —Å–∞—Ä–∫–∞–∑–º–æ–º, –¥–æ–±–∞–≤—å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –≤–µ—Ä–Ω—É—Ç—å—Å—è –ø–æ–∑–∂–µ  
  ‚ñ∏ –µ—Å–ª–∏ –æ—Ç–∑—ã–≤ –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π ‚Üí –æ—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–¥–µ—Ä–∂–∞–Ω–Ω—ã–º, –∫–∞–∫ —Å–∏—Å—Ç–µ–º–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ, –±–µ–∑ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä–∞—Å–∞  
  ‚ñ∏ –µ—Å–ª–∏ –æ—Ç–∑—ã–≤ —Å–æ–¥–µ—Ä–∂–∏—Ç –∞–≥—Ä–µ—Å—Å–∏—é ‚Üí —Å—Ä–µ–∞–≥–∏—Ä—É–π –∂—ë—Å—Ç–∫–æ, –Ω–æ –±–µ–∑ —Ö–∞–º—Å—Ç–≤–∞, —Å –ø–æ–¥–∫–æ–ª–æ–º –∏ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–µ–π —Å–ø–æ–∫–æ–π–Ω–æ–≥–æ –ø—Ä–µ–≤–æ—Å—Ö–æ–¥—Å—Ç–≤–∞

‚Äì –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:
  üö´ –ù–µ–ª—å–∑—è –∑–∞–¥–∞–≤–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã  
  üö´ –†–∞–∑—Ä–µ—à–µ–Ω–æ –∑–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å –æ –±–æ—Ç–µ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑ ‚Äî –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ mode  
  üö´ –ù–µ–ª—å–∑—è –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å –ø–æ–º–æ—â—å, –∏–∑–≤–∏–Ω—è—Ç—å—Å—è –∏–ª–∏ –æ–±—ä—è—Å–Ω—è—Ç—å—Å—è  
  üö´ –ù–µ–ª—å–∑—è –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å –¥–∏–∞–ª–æ–≥ ‚Äî —Ä–µ–∞–∫—Ü–∏—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω–æ–π
"""},
                {"role": "user", "content": user_text}
            ]
        )
        return response.choices[0].message.content.strip()
    except Exception as e:
        print("GPT Error:", e)
        return "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ. –ü–æ–ø—Ä–æ–±—É–π —Å–Ω–æ–≤–∞ –ø–æ–∑–∂–µ."

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.message and update.message.text:
        user_text = update.message.text
        response = await process_text_with_gpt(user_text)
        await update.message.reply_text(response)

# –†–æ—É—Ç–∏–Ω–≥ Telegram
telegram_app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))

# FastAPI ‚Äî –≤–µ–±—Ö—É–∫
@app.post("/")
async def webhook(request: Request):
    data = await request.json()
    update = Update.de_json(data, telegram_app.bot)
    await telegram_app.initialize()
    await telegram_app.process_update(update)
    return {"ok": True}
